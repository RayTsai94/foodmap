{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}é¤å»³æ¢ç´¢åœ°åœ– - NCU é£Ÿç‰©åœ°åœ–{% endblock %}

{% block extra_css %}
<style>
    #restaurant-map {
        width: 100%;
        height: 400px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    .map-info-window {
        padding: 5px;
        max-width: 250px;
    }
    .filter-section {
        background: linear-gradient(135deg, #ff9a56 0%, #ffad56 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
    }
    .filter-section .form-control,
    .filter-section .form-select {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 8px;
    }
    
    /* æœç´¢å»ºè­°æ¨£å¼ */
    .search-container {
        position: relative;
    }
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .suggestion-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    .suggestion-item:hover,
    .suggestion-item.active {
        background-color: #f8f9fa;
    }
    .suggestion-item:last-child {
        border-bottom: none;
    }
    .suggestion-restaurant {
        display: flex;
        align-items: center;
    }
    .suggestion-restaurant .restaurant-image {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        margin-right: 12px;
        object-fit: cover;
    }
    .suggestion-restaurant .restaurant-info {
        flex: 1;
    }
    .suggestion-restaurant .restaurant-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
    }
    .suggestion-restaurant .restaurant-address {
        font-size: 0.85em;
        color: #666;
    }
    .suggestion-restaurant .restaurant-rating {
        display: flex;
        align-items: center;
        margin-top: 2px;
    }
    .suggestion-restaurant .rating-stars {
        margin-right: 5px;
    }
    .suggestion-restaurant .rating-text {
        font-size: 0.8em;
        color: #666;
    }
    .suggestion-category {
        display: flex;
        align-items: center;
        color: #ff9a56;
    }
    .suggestion-category .category-icon {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    .suggestion-category .category-info {
        flex: 1;
    }
    .suggestion-category .category-name {
        font-weight: 500;
    }
    .suggestion-category .category-count {
        font-size: 0.85em;
        color: #666;
    }
    .highlight {
        background-color: #fff3cd;
        font-weight: 500;
    }
    
    .restaurant-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }
    .restaurant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(255, 154, 86, 0.3);
    }
    .view-toggle {
        background: white;
        border-radius: 25px;
        padding: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .view-toggle .btn {
        border-radius: 20px;
        padding: 8px 20px;
        border: none;
        transition: all 0.3s;
    }
    .view-toggle .btn.active {
        background: #ff9a56;
        color: white;
    }
    .btn-primary {
        background-color: #ff9a56;
        border-color: #ff9a56;
    }
    .btn-primary:hover {
        background-color: #ff8c42;
        border-color: #ff8c42;
    }
    .text-primary {
        color: #ff9a56 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-3">ğŸ—ºï¸ é¤å»³æ¢ç´¢åœ°åœ–</h1>
            <p class="text-center text-muted">æœå°‹é—œéµå­—æˆ–é¸æ“‡åˆ†é¡ï¼Œåœ¨åœ°åœ–ä¸Šæ‰¾åˆ°æœ€é©åˆçš„é¤å»³</p>
        </div>
    </div>
    
    <!-- æœå°‹éæ¿¾å€åŸŸ -->
    <div class="d-flex justify-content-center">
        <div class="filter-section" style="width:100%; max-width:700px;">
            <form method="get" id="filter-form">
                <div class="row mb-3 g-2">
                    <div class="col-12">
                        <label class="form-label fw-bold">ğŸ” æœå°‹é¤å»³</label>
                        <div class="search-container">
                            <input type="text" class="form-control form-control-sm"
                                   id="search-input" name="name_or_address"
                                   value="{{ request.GET.name_or_address }}"
                                   placeholder="è¼¸å…¥é¤å»³åç¨±ã€åœ°å€æˆ–åˆ†é¡é—œéµå­—..." autocomplete="off">
                            <div class="search-suggestions" id="search-suggestions"></div>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold">ğŸ½ï¸ åˆ†é¡</label>
                        {{ filter_form.category|as_crispy_field }}
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold">â­ æœ€ä½è©•åˆ†</label>
                        {{ filter_form.min_rating|as_crispy_field }}
                    </div>
                    <div class="col-12 d-grid">
                        <button type="submit" class="btn btn-light fw-bold" style="height:38px;">
                            <i class="fas fa-search me-2"></i>æœå°‹
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- æª¢è¦–åˆ‡æ› -->
    <div class="d-flex justify-content-center mb-4">
        <div class="view-toggle">
            <button class="btn active" id="map-view-btn" onclick="showMapView()">
                <i class="fas fa-map-marked-alt me-2"></i>åœ°åœ–æª¢è¦–
            </button>
            <button class="btn" id="list-view-btn" onclick="showListView()">
                <i class="fas fa-list me-2"></i>åˆ—è¡¨æª¢è¦–
            </button>
        </div>
    </div>

    <!-- åœ°åœ–å€åŸŸ -->
    <div id="map-section">
        <div id="restaurant-map"></div>
        {% if page_obj %}
            <div class="alert alert-info text-center">
                <i class="fas fa-map-marker-alt me-2"></i>
                æ‰¾åˆ° {{ page_obj.paginator.count }} é–“é¤å»³ï¼Œé»æ“Šåœ°åœ–æ¨™è¨˜æŸ¥çœ‹è©³ç´°è³‡è¨Š
            </div>
        {% endif %}
    </div>

    <!-- é¤å»³åˆ—è¡¨å€åŸŸ -->
    <div id="list-section" style="display: none;">
        <div class="row">
            {% for restaurant in page_obj %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card restaurant-card h-100">
                        {% if restaurant.image %}
                            <img src="{{ restaurant.image.url }}" class="card-img-top" alt="{{ restaurant.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'img/default-restaurant.jpg' %}" class="card-img-top" alt="{{ restaurant.name }}" style="height: 200px; object-fit: cover;">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ restaurant.name }}</h5>
                            <div class="mb-2">
                                {% for category in restaurant.categories.all %}
                                    <span class="badge bg-secondary rounded-pill">{{ category.name }}</span>
                                {% endfor %}
                            </div>
                            <p class="card-text text-muted small">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ restaurant.address }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="rating">
                                    {% with restaurant.reviews.all as reviews %}
                                        {% if reviews %}
                                            {% with reviews|length as review_count %}
                                                {% with reviews|dictsort:"rating"|last as highest_review %}
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= highest_review.rating %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-warning"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <small class="ms-1 text-muted">{{ highest_review.rating }} ({{ review_count }})</small>
                                                {% endwith %}
                                            {% endwith %}
                                        {% else %}
                                            <small class="text-muted">å°šç„¡è©•åˆ†</small>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <a href="{% url 'restaurant_detail' restaurant.pk %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-search me-2"></i>
                        æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³ã€‚è«‹å˜—è©¦å…¶ä»–æœå°‹æ¢ä»¶ã€‚
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- åˆ†é æ§åˆ¶ -->
        {% if page_obj.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for i in page_obj.paginator.page_range %}
                        {% if page_obj.number == i %}
                            <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initRestaurantMap" async defer></script>
<script>
let map;
let markers = [];
let infoWindow;

const restaurants = {{ restaurant_json|safe }};

function initRestaurantMap() {
    // è¨­ç½®ä¸­å¤®å¤§å­¸çš„åº§æ¨™ä½ç½®
    const ncuLocation = { lat: 24.9677, lng: 121.1892 };
    
    // å‰µå»ºåœ°åœ–
    map = new google.maps.Map(document.getElementById('restaurant-map'), {
        center: ncuLocation,
        zoom: 15,
        styles: [
            {
                "featureType": "poi.business",
                "elementType": "labels",
                "stylers": [{"visibility": "off"}]
            }
        ]
    });
    
    // å‰µå»ºä¿¡æ¯çª—å£
    infoWindow = new google.maps.InfoWindow();
    
    // æ·»åŠ ä¸­å¤®å¤§å­¸æ¨™è¨˜
    const ncuMarker = new google.maps.Marker({
        position: ncuLocation,
        map: map,
        title: 'åœ‹ç«‹ä¸­å¤®å¤§å­¸',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
        },
        zIndex: 999
    });
    
    // æ·»åŠ é¤å»³æ¨™è¨˜
    restaurants.forEach(restaurant => {
        const marker = new google.maps.Marker({
            position: { lat: restaurant.lat, lng: restaurant.lng },
            map: map,
            title: restaurant.name,
            icon: {
                url: "{% static 'images/logo.png' %}",
                scaledSize: new google.maps.Size(40, 40),
            }
        });
        
        const infoContent = `
            <div class="map-info-window">
                <img src="${restaurant.image}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                <h6 class="fw-bold text-primary">${restaurant.name}</h6>
                <p class="small text-muted mb-2">
                    <i class="fas fa-map-marker-alt me-1"></i>${restaurant.address}
                </p>
                <p class="small mb-2">
                    <i class="fas fa-tags me-1"></i>${restaurant.categories}
                </p>
                <a href="${restaurant.url}" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è©³æƒ…
                </a>
            </div>
        `;
        
        marker.addListener('click', () => {
            infoWindow.setContent(infoContent);
            infoWindow.open(map, marker);
        });
        
        markers.push(marker);
    });
    
    // å¦‚æœæœ‰é¤å»³ï¼Œèª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰é¤å»³
    if (restaurants.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        restaurants.forEach(restaurant => {
            bounds.extend(new google.maps.LatLng(restaurant.lat, restaurant.lng));
        });
        bounds.extend(ncuLocation); // ä¹ŸåŒ…å«ä¸­å¤®å¤§å­¸
        map.fitBounds(bounds);
    }
}

function showMapView() {
    document.getElementById('map-section').style.display = 'block';
    document.getElementById('list-section').style.display = 'none';
    document.getElementById('map-view-btn').classList.add('active');
    document.getElementById('list-view-btn').classList.remove('active');
    
    // é‡æ–°èª¿æ•´åœ°åœ–å¤§å°
    if (map) {
        google.maps.event.trigger(map, 'resize');
    }
}

function showListView() {
    document.getElementById('map-section').style.display = 'none';
    document.getElementById('list-section').style.display = 'block';
    document.getElementById('map-view-btn').classList.remove('active');
    document.getElementById('list-view-btn').classList.add('active');
}

// æœç´¢å»ºè­°åŠŸèƒ½
let searchTimeout;
let currentSuggestionIndex = -1;

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchSuggestions = document.getElementById('search-suggestions');
    
    // è¼¸å…¥äº‹ä»¶è™•ç†
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ™‚å™¨
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            hideSuggestions();
            return;
        }
        
        // å»¶é²æœç´¢ä»¥é¿å…éå¤šè«‹æ±‚
        searchTimeout = setTimeout(() => {
            fetchSuggestions(query);
        }, 300);
    });
    
    // éµç›¤å°èˆª
    searchInput.addEventListener('keydown', function(e) {
        const suggestions = searchSuggestions.querySelectorAll('.suggestion-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, suggestions.length - 1);
            updateSuggestionSelection(suggestions);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
            updateSuggestionSelection(suggestions);
        } else if (e.key === 'Enter') {
            if (currentSuggestionIndex >= 0 && suggestions[currentSuggestionIndex]) {
                e.preventDefault();
                selectSuggestion(suggestions[currentSuggestionIndex]);
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });
    
    // é»æ“Šå¤–éƒ¨éš±è—å»ºè­°
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
            hideSuggestions();
        }
    });
});

function fetchSuggestions(query) {
    fetch(`{% url 'search_suggestions' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            displaySuggestions(data.suggestions, query);
        })
        .catch(error => {
            console.error('æœç´¢å»ºè­°éŒ¯èª¤:', error);
        });
}

function displaySuggestions(suggestions, query) {
    const searchSuggestions = document.getElementById('search-suggestions');
    
    if (suggestions.length === 0) {
        hideSuggestions();
        return;
    }
    
    let html = '';
    
    suggestions.forEach((suggestion, index) => {
        if (suggestion.type === 'restaurant') {
            const stars = generateStars(suggestion.avg_rating);
            const highlightedName = highlightText(suggestion.name, query);
            const highlightedAddress = highlightText(suggestion.address, query);
            
            html += `
                <div class="suggestion-item" data-type="restaurant" data-id="${suggestion.id}" data-name="${suggestion.name}">
                    <div class="suggestion-restaurant">
                        ${suggestion.image_url ? 
                            `<img src="${suggestion.image_url}" class="restaurant-image" alt="${suggestion.name}">` : 
                            `<div class="restaurant-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;"><i class="fas fa-utensils"></i></div>`
                        }
                        <div class="restaurant-info">
                            <div class="restaurant-name">${highlightedName}</div>
                            <div class="restaurant-address">${highlightedAddress}</div>
                            <div class="restaurant-rating">
                                <div class="rating-stars">${stars}</div>
                                <div class="rating-text">
                                    ${suggestion.avg_rating > 0 ? `${suggestion.avg_rating} (${suggestion.review_count})` : 'å°šç„¡è©•åˆ†'}
                                </div>
                            </div>
                            ${suggestion.categories.length > 0 ? 
                                `<div class="mt-1">${suggestion.categories.map(cat => `<span class="badge bg-secondary rounded-pill me-1" style="font-size: 0.7em;">${cat}</span>`).join('')}</div>` : 
                                ''
                            }
                        </div>
                    </div>
                </div>
            `;
        } else if (suggestion.type === 'category') {
            const highlightedName = highlightText(suggestion.name, query);
            
            html += `
                <div class="suggestion-item" data-type="category" data-name="${suggestion.name}">
                    <div class="suggestion-category">
                        <div class="category-icon">
                            <i class="${suggestion.icon}"></i>
                        </div>
                        <div class="category-info">
                            <div class="category-name">${highlightedName}</div>
                            <div class="category-count">${suggestion.restaurant_count} é–“é¤å»³</div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    searchSuggestions.innerHTML = html;
    searchSuggestions.style.display = 'block';
    currentSuggestionIndex = -1;
    
    // æ·»åŠ é»æ“Šäº‹ä»¶
    searchSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => selectSuggestion(item));
    });
}

function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="fas fa-star text-warning"></i>';
        } else {
            stars += '<i class="far fa-star text-warning"></i>';
        }
    }
    return stars;
}

function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function updateSuggestionSelection(suggestions) {
    suggestions.forEach((item, index) => {
        if (index === currentSuggestionIndex) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function selectSuggestion(item) {
    const searchInput = document.getElementById('search-input');
    const type = item.dataset.type;
    
    if (type === 'restaurant') {
        searchInput.value = item.dataset.name;
    } else if (type === 'category') {
        searchInput.value = item.dataset.name;
    }
    
    hideSuggestions();
    
    // è‡ªå‹•æäº¤æœç´¢
    document.getElementById('filter-form').submit();
}

function hideSuggestions() {
    document.getElementById('search-suggestions').style.display = 'none';
    currentSuggestionIndex = -1;
}
</script>
{% endblock %} 